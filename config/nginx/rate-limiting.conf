# 速率限制配置 - 防止暴力破解和 DDoS 攻擊

# 定義速率限制區域
# 一般請求限制：每 IP 每分鐘 60 個請求
limit_req_zone $binary_remote_addr zone=general:10m rate=60r/m;

# 登入頁面限制：每 IP 每分鐘 5 次嘗試
limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;

# XML-RPC 限制：每 IP 每分鐘 10 次請求
limit_req_zone $binary_remote_addr zone=xmlrpc:10m rate=10r/m;

# API 限制：每 IP 每分鐘 30 次請求
limit_req_zone $binary_remote_addr zone=api:10m rate=30r/m;

# 連接數限制：每 IP 最多 10 個並發連接
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
limit_conn conn_limit_per_ip 10;

# 應用速率限制
limit_req_status 429;
limit_conn_status 429;

# 健康檢查端點不應用速率限制
map $request_uri $health_check {
    ~^/health$ 1;
    default 0;
}
